<div class="flex h-screen">
  <aside class={sidebar_classes(@collapsed)}>
    <div class="flex justify-between items-center p-3 border-b">
      <span :if={!@collapsed} class="text-lg font-semibold">DashboardGen</span>
      <button phx-click="toggle_sidebar" aria-label="Toggle sidebar">
        <%= if @collapsed, do: "▶", else: "◀" %>
      </button>
    </div>

    <nav class="space-y-2 p-3">
      <Phoenix.Component.link navigate={~p"/"} class="nav-item flex items-center gap-2 text-sm hover:underline">
        📊 <%= unless @collapsed, do: "Dashboard" %>
      </Phoenix.Component.link>
      <Phoenix.Component.link navigate={~p"/saved"} class="nav-item flex items-center gap-2 text-sm hover:underline">
        💾 <%= unless @collapsed, do: "Saved Views" %>
      </Phoenix.Component.link>
      <Phoenix.Component.link navigate={~p"/settings"} class="nav-item flex items-center gap-2 text-sm hover:underline">
        ⚙️ <%= unless @collapsed, do: "Settings" %>
      </Phoenix.Component.link>
      <Phoenix.Component.link navigate={~p"/uploads"} class="nav-item flex items-center gap-2 text-sm hover:underline">
        📁 <%= unless @collapsed, do: "Uploads" %>
      </Phoenix.Component.link>
    </nav>

    <div class="absolute bottom-4 left-4" phx-click-away="hide_user_menu">
      <div phx-click="toggle_user_menu" class="flex items-center space-x-2 cursor-pointer">
        <div class="bg-gray-300 rounded-full h-8 w-8 flex items-center justify-center text-sm font-bold">
          <%= initials(@current_user.name || @current_user.email) %>
        </div>
        <div :if={!@collapsed} class="text-sm">
          <div class="font-medium"><%= @current_user.name || @current_user.email %></div>
          <div class="text-gray-400 text-xs">Signed in</div>
        </div>
      </div>

      <%= if @show_user_menu do %>
        <div class="mt-2 w-48 bg-white shadow-lg border rounded text-sm">
          <a href="/settings" class="block px-4 py-2 hover:bg-gray-100">⚙️ Settings</a>
          <form method="post" action="/logout">
            <button type="submit" class="w-full text-left px-4 py-2 hover:bg-gray-100">🚪 Log out</button>
          </form>
        </div>
      <% end %>
    </div>
  </aside>

  <main class="flex-1 flex flex-col justify-between overflow-y-auto">
    <div class="p-6 space-y-6 overflow-y-auto">
      <%= if live_flash(@flash, :error) do %>
        <div class="text-red-600"><%= live_flash(@flash, :error) %></div>
      <% end %>

    <%= if @loading do %>
      <div class="text-gray-500">Generating...</div>
    <% end %>

    <%= if @alerts do %>
      <div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-900 p-4 rounded text-sm">
        <strong>⚠️ Alert:</strong>
        <ul class="list-disc pl-6 space-y-1 text-sm text-yellow-900">
          <%= for line <- String.split(@alerts, "\n", trim: true) do %>
            <li><%= line %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <%= if @chart_spec do %>
      <div id="chart-container" phx-hook="VegaLiteChart" phx-update="ignore" data-spec={@chart_spec} />
      <div class="mt-4 space-x-2">
        <%= if !@summary && !@loading do %>
          <button phx-click="generate_summary" class="btn">Generate Insight</button>
        <% end %>
        <button phx-click="explain_this" class="btn-secondary">Explain This</button>
        <button phx-click="why_this" class="btn-secondary">Why Did This Happen?</button>
      </div>
    <% end %>

    <%= if @summary do %>
      <div class="bg-gray-50 p-4 rounded text-sm text-gray-700">
        <strong>Insight:</strong> <%= @summary %>
      </div>
    <% end %>
    <%= if @explanation do %>
      <div class="bg-yellow-50 p-4 rounded mt-4 text-sm text-yellow-900">
        <strong>Explanation:</strong> <%= @explanation %>
      </div>
    <% end %>
    </div>

    <form phx-submit="generate" class="p-6 bg-white border-t">
      <div class="flex items-end gap-2 border border-gray-300 rounded-xl shadow-sm p-3 bg-white">
        <textarea
          name="prompt"
          rows="1"
          placeholder="Describe your query..."
          class="flex-1 resize-none rounded-md border-none outline-none focus:ring-0 text-sm"
        ></textarea>
        <button type="submit" class="bg-black text-white rounded-full px-3 py-1 text-sm">➤</button>
      </div>
    </form>
  </main>
</div>

